import urllib.request
import urllib.error
import json

class GraphQLClient:
    def __init__(self, endpoint):
        self.endpoint = endpoint
        self.token = None
        self.headername = None

    def execute(self, query, variables=None):
        return self._send(query, variables)

    def inject_token(self, token, headername='Authorization'):
        self.token = token
        self.headername = headername

    def _send(self, query, variables):
        data = json.dumps(
            {'query': query,'variables': variables}
        )
        headers = {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }

        if self.token is not None:
            headers[self.headername] = '{}'.format(self.token)

        try:
            response = urllib.request.urlopen(self.endpoint, data, headers)
            rr = response.read().replace("\\n", "\n")
            return json.loads(rr)
        except urllib.error.HTTPError as e:
            print(e)
            raise e
